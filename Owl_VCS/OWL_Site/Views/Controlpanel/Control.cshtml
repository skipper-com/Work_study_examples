<script src="@Url.Content("~/Scripts/DataTables/datatables.select.min.js")"></script>
<body onload="user.join()">
    <div id="confcontrol" class="control_panel">
        <table class="controltable">
            <tr>
                <td class="controlcol">
                    <div id="roster" class="roster">
                        <div id="roster_list" class="roster_list">
                            <ul class="roster_entry_ul">
                                <div class="roster_entry_ul_header">
                                    <b>Участники виртуальной переговорной комнаты</b>
                                </div>
                                <div class="roster_entry_ul_header_coference_control">
                                    <i id="host" onclick="user.lock()"></i>
                                    <i id="conflock" onclick="user.lock()"></i>
                                    <i id="guestsmuted" onclick="user.muteallguests()"></i>
                                    <i id="disconnectall" onclick="user.disconnect_all()"></i>
                                    <i id="record" onclick="user.record()"></i>
                                </div>
                            </ul>
                        </div>
                    </div>
                    <div style="min-height: 10px; width: 100%"></div>
                    <div id="waitingroom" class="waitingroom">
                        <div id="waitingroom_list" class="waitingroom_list">
                            <ul class="roster_entry_ul">
                                <div class="roster_entry_ul_header">
                                    <b>Комната ожидания</b>
                                </div>
                            </ul>
                        </div>
                    </div>
                        <div style="min-height: 10px; width: 100%"></div>
                        <div id="dialdiv" class="dialdiv">
                            <fieldset>
                                <legend class="dialdiv_legend">Подключить участника</legend>
                                <div class="dialdiv_container">
                                    <div class="dialdiv_protocol">
                                        <label class="dialdiv_header">Протокол </label>
                                        <select id="protocol" value="sip" class="form-control dial_protocol">
                                            <option value="sip">SIP</option>
                                            <option value="h323">H.323</option>
                                            <option value="mssip">Lync</option>
                                            <option value="rtmp">RTMP</option>
                                        </select>
                                        <br />
                                        <label class="dialdiv_header">Роль </label>
                                        <select id="role" value="guest" class="form-control dial_protocol">
                                            <option value="guest">гость</option>
                                            <option value="host">хост</option>
                                        </select>
                                        <br />
                                        <label class="dialdiv_header">Адрес вызываемого абонента</label>
                                        <input id="remotealias" value="" class="form-control dial_alias">
                                    </div>
                                    <input id="dial" type="button" onclick="user.dial()" value="Вызвать" class="dialdiv_button" />
                                    <input id="dial" type="button" onclick="display_pb()" value="Добавить из адресной книги" class="dialdiv_button" />
                                </div>
                            </fieldset>
                        </div>
</td>
                <td class="controlcol">
                    <div id="layoutdiv" class="layoutdiv">
                        <fieldset>
                            <legend class="layoutdiv_legend">Управление раскладкой видео</legend>
                            <div class="layout_layout_1">
                                <label class="layoutdiv_header">Участники </label>
                                <label class="layoutdiv_header">Управление раскладками </label>
                                <label class="layoutdiv_header">Показ +N окошка</label>
                            </div>
                            <div class="layout_layout_2">
                                <select id="actors" value="everyone" class="form-control layoutdiv_select">
                                    <option value="everyone">все</option>
                                    <option value="selected">выбранные</option>
                                </select>
                                <select id="layout" value="1:7" class="form-control layoutdiv_select">
                                    <option value="1:0">1 основной</option>
                                    <option value="4:0">2 на 2</option>
                                    <option value="1:7">1 основной + 7 дополнительных</option>
                                    <option value="1:21">1 основной + 21 дополнительных</option>
                                </select>
                                <select id="plusn" value="auto" class="form-control layoutdiv_select">
                                    <option value="auto">авто</option>
                                    <option value="off">откл.</option>
                                </select>
                                <!--<input id="plusn" list="plusnvalues" value="auto" class="form-control layoutdiv_select"/>
                                <datalist id="plusnvalues"><option id="auto_option" value="auto"><option value="off"/></datalist>-->

                            </div>
                            <div class="layout_layout_3">
                                <label class="layoutdiv_header">Выход со сцены</label>
                                <label class="layoutdiv_header">Экранные подписи</label>
                                <label class="layoutdiv_header">Для участников:</label>
                            </div>
                            <div class="layout_layout_4">
                                <input type="checkbox" id="vadbackfill" checked />
                                <select id="overlay_text" value="off" class="form-control layoutdiv_select">
                                    <option value="off">откл</option>
                                    <option value="auto">авто</option>
                                </select>
                                <select id="audience" value="everyone" onchange="update_audience()" class="form-control layoutdiv_select">
                                    <option value="everyone">всех</option>
                                    <option value="hosts">только для гостей</option>
                                </select>
                            </div>
                            <br />
                            <div id="guestlayout" class="hide">
                                <div class="layout_layout_1">
                                    <label class="layoutdiv_header">Участники </label>
                                    <label class="layoutdiv_header">Управление раскладками </label>
                                    <label class="layoutdiv_header">PlusN (откл/авто/n)</label>
                                </div>
                                <br />
                                <div class="layout_layout_2">
                                    <select id="guest_actors" value="everyone" class="form-control layoutdiv_select">
                                        <option value="everyone">все</option>
                                        <option value="selected">выбранные</option>
                                    </select>
                                    <select id="guest_layout" value="1:7" class="form-control layoutdiv_select">
                                        <option value="1:0">1 основной</option>
                                        <option value="4:0">ОдинаковоеEqual layout</option>
                                        <option value="1:7">1 основной + 7 дополнительных</option>
                                        <option value="1:21">1 основной + 21 дополнительных</option>
                                    </select>
                                    <input id="plusn" list="plusnvalues" value="auto" class="form-control layoutdiv_select" />
                                    <datalist id="plusnvalues"><option id="auto_option" value="auto"><option value="off"></datalist>
                                </div>
                                <div class="layout_layout_3">
                                    <label class="layoutdiv_header">VAD backfill </label>
                                    <label class="layoutdiv_header">Экранные надписи </label>
                                    <label class="layoutdiv_header">Для участников:</label>
                                </div>
                                <br />
                                <div class="layout_layout_4">
                                    <input type="checkbox" id="guest_vadbackfill" checked />
                                    <select id="guest_overlay_text" value="off" class="form-control layoutdiv_select">
                                        <option value="off">откл</option>
                                        <option value="auto">авто</option>
                                    </select>
                                    <select id="guest_audience" value="guests" class="form-control layoutdiv_select">
                                        <option value="guests">гостей</option>
                                    </select>
                                </div>
                            </div>
                            <input id="overridelayout" type="button" onclick="user.overridelayout()" value="Изменить раскладку" class="layoutdiv_button" />
                            <input id="resetlayout" type="button" onclick="user.resetlayout()" value="Вернуть исходное состояние" class="layoutdiv_button" /><br />
                        </fieldset>
                    </div>
                    <div style="min-height: 10px; width: 100%"></div>
                    <div id="liveviewdiv" class="liveviewdiv">
                        <fieldset>
                            <legend class="liveviewdiv_legend">Сейчас транслируется в комнате</legend>
                            <div id="liveviewplayer" class="liveviewdiv_player"></div>
                            <img id="presentation" class="liveviewdiv_player"><br />
                            <input id="liveview" type="button" onclick="user.liveview()" value="Просмотр видео" class="liveviewdiv_livebutton" />
                            <br />
                            <div class="liveviewdiv_rtmp">
                                <input id="rtmpaddress" class="form-control liveviewdiv_rtmptext" />
                                <input id="getrtmpaddress" type="button" onclick="user.getrtmpaddress()" value="Получить RTMP ссылку" class="liveviewdiv_rtmpbutton" />
                            </div>
                        </fieldset>
                    </div>
                    <div style="min-height: 10px; width: 100%"></div>
                    <div id="chatdiv" class="chatdiv">
                        <fieldset>
                            <legend class="chatdiv_legend">Чат вирутальной переговорной комнаты</legend>
                            <form onsubmit="return user.send_message()">
                                <div id="chatbox" class="chatbox"></div><br/>
                                <input id="chatinput" style="width: 70%;" class="form-control chatdiv_text" />
                                <input id="chatsend" type="button" onclick="user.send_message()" value="Отправить" class="chatdiv_button" />
                            </form>
                        </fieldset>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div id="popup_block" class="hide">
        <div id="popup_content" class="b-popup b-popup-content">
            <table id="table_du">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Фамилия</th>
                        <th>Должность</th>
                        <th>Телефон (внут.)</th>
                        <th>Email</th>
                        <th>Группа</th>
                        <th>SIP-адрес</th>
                        <th>H.323-адрес</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="phonebook_buttons">
                <input id="save" type="button" onclick="add_pb_user()" value="Подключить" class="phonebook_button_add" />
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    var oPhonebookTable;

    function display_pb() {
        event.stopPropagation();
        document.getElementById("popup_block").className = "b-popup b-popup-content";
        if (oPhonebookTable == null) {
            popup_pb_table();
        } else {
            setTimeout(refresh_pb, 500);
        }

    };

    $(document).on("click", function (e) {
        if (!$("#popup_content").is(e.target) && $("#popup_content").has(e.target).length == 0 && document.getElementById("popup_block").className == "b-popup b-popup-content") {
            document.getElementById("popup_block").className = "hide";
        };
    });

    function refresh_pb() {
        if (oPhonebookTable != null)
            oPhonebookTable.ajax.reload();
    };

    function add_pb_user() {
        var sip_add = oPhonebookTable.cells('.selected', 7, { page: 'current' }).data();
        var h323_add = oPhonebookTable.cells('.selected', 8, { page: 'current' }).data();
        var imya = oPhonebookTable.cells('.selected', 1, { page: 'current' }).data();
        var fam = oPhonebookTable.cells('.selected', 2, { page: 'current' }).data();
        for (var i = 0; i < sip_add.length; i++) {
            name = imya[i] + " " + fam[i];
            if (sip_add[i] !== '') {
                user.dial_pb(sip_add[i], "sip", name);
            } else {
                user.dial_pb(h323_add[i], "h323", name);
            }

        }
        document.getElementById("popup_block").className = "hide";
    };

    function popup_pb_table() {
        oPhonebookTable = $('#table_du').DataTable({
            "ordering": true,
            "searching": true,
            "paging": true,
            "autoWidth": true,
            "processing": true,
            "lengthChange": false,
            "order": [[2, 'asc']],
            "pageLength": 30,
            "select": {
                "style": 'multi',
            },

            "ajax": {
                "type": "POST",
                "url": "/Phonebook/Phonebook_Ajax",
                "contentType": 'application/json; charset=utf-8',
                "data": function (data) { return data = JSON.stringify(data); }
            },

            "columns": [
                { "data": "id", "visible": false },
                { "data": "name" },
                { "data": "surname" },
                { "data": "position", "searchable": false },
                { "data": "tel_int" },
                { "data": "email" },
                { "data": "group", "searchable": false },
                { "data": "sip_add", "searchable": false },
                { "data": "h323_add", "searchable": false },
            ],

            "drawCallback": function (settings) {
                var api = this.api();
                var rows = api.rows({ page: 'current' }).nodes();
                var last = null;

                api.column(6, { page: 'current' }).data().each(function (group, i) {
                    if (last !== group) {
                        $(rows).eq(i).before(
                            '<tr class="phonebook_groups"><td colspan="12">' + group + '</td></tr>'
                        );
                        last = group;
                    }
                });
            },

            "language": {
                "processing": "Подождите...",
                "search": "Поиск:",
                "lengthMenu": "Показать _MENU_ записей",
                "info": "Записи с _START_ до _END_ из _TOTAL_ записей",
                "infoEmpty": "Записи с 0 до 0 из 0 записей",
                "infoFiltered": "(отфильтровано из _MAX_ записей)",
                "infoPostFix": "",
                "loadingRecords": "Загрузка записей...",
                "zeroRecords": "Записи отсутствуют.",
                "emptyTable": "В таблице отсутствуют данные",
                "paginate": {
                    "first": "Первая",
                    "previous": "Предыдущая",
                    "next": "Следующая",
                    "last": "Последняя"
                },
                "aria": {
                    "sortAscending": ": активировать для сортировки столбца по возрастанию",
                    "sortDescending": ": активировать для сортировки столбца по убыванию"
                }
            },

        });
    };


    $('#roster_list').slimScroll({
        height: '100%',
        width: '100%',
        size: '7px',
        position: 'right',
        color: '#332383',
        distance: '1px',
    });
    $('#waitingroom_list').slimScroll({
        height: '100%',
        width: '100%',
        size: '7px',
        position: 'right',
        color: '#332383',
        distance: '1px',
    });
    $('#chatbox').slimScroll({
        height: '280px',
        width: '100%',
        size: '7px',
        position: 'right',
        color: '#332383',
        distance: '1px',
    });


    // className strings
    var class_disconnect = "participant_action fa fa-eject fa-fw red";
    var class_mute_on = "participant_action fa fa-microphone-slash fa-fw red";
    var class_mute_off = "participant_action fa fa-microphone fa-fw green";
    var class_hold_on = "participant_action fa fa-play fa-fw";
    var class_hold_off = "participant_action fa fa-pause fa-fw";
    var class_lock_on = "participant_action fa fa-lock fa-fw red";
    var class_spotlight_on = "participant_action fa fa-star fa-fw yellow";
    var class_spotlight_off = "participant_action fa fa-star-o fa-fw yellow";
    var class_see_presentation_allowed = "participant_action fa fa-bar-chart-o fa-fw green";
    var class_see_presentation_denied = "participant_action fa fa-bar-chart-o fa-fw red";
    var class_overlay = "participant_action fa fa-font fa-fw";
    var class_conference_lock_on = "conference_action fa fa-lock fa-fw red";
    var class_conference_lock_off = "conference_action fa fa-unlock fa-fw green";
    var class_conference_guests_mute_on = "conference_action fa fa-microphone-slash fa-fw red";
    var class_conference_guests_mute_off = "conference_action fa fa-microphone fa-fw green";
    var class_conference_disconnect_all = "conference_action fa fa-eject fa-fw red";
    var class_overlay_text_commit = "participant_action fa fa-check fa-fw white";
    var class_conference_record_off = "participant_action fa fa-circle fa-fw red";
    var class_conference_record_on = "participant_action fa fa-circle-blink fa-fw red";
    var class_role_chair = "participant_action fa fa-user-plus fa-fw";
    var class_role_guest = "participant_action fa fa-user fa-fw";


    function DumpObject(obj) {
        var od = new Object;
        var result = "";
        var len = 0;

        for (var property in obj) {
            var value = obj[property];
            if (typeof value == 'string')
                value = "'" + value + "'";
            else if (typeof value == 'object') {
                if (value instanceof Array) {
                    value = "[ " + value + " ]";
                }
                else {
                    var ood = DumpObject(value);
                    value = "{ " + ood.dump + " }";
                }
            }
            result += "'" + property + "' : " + value + ", ";
            len++;
        }
        od.dump = result.replace(/, $/, "");
        od.len = len;

        return od;
    }

    function getURLParameter(name) {
        // Only find single (first) entry of name for now
        var value = null;
        var regex = new RegExp('[?|&]' + name + '(=([^&;]+?)(&|#|;|$))?').exec(location.search);
        if (regex) {
            value = regex[2] || name;
        }
        if (value) {
            return decodeURIComponent(value);
        } else {
            return null;
        }
    }

    function update_audience() {
        // Audience drop down updated
        // If hosts is selected, make sure auto is removed from plus_n
        // and show guest view params and add it back if everyone selected
        // and hide guest view params
        var auto_option = document.getElementById("auto_option");
        var plus_n_element = document.getElementById("plusn");
        var audience_element = document.getElementById("audience");
        var guestlayout_element = document.getElementById("guestlayout");
        if (audience_element.value == 'hosts') {
            auto_option.disabled = true;
            if (plus_n_element.value == 'auto') {
                plus_n_element.value = 'off';
            }
            guestlayout_element.className = "";
        } else {
            auto_option.disabled = false;
            guestlayout_element.className = "hide";
        }
    }

    function Participant(participant_data) {
        this.uuid = participant_data["uuid"];
        this.speaking = false;
        this.element_root = document.createElement("li");
        if (participant_data["role"] == "chair") {
            this.element_root.className = "roster_entry_host_li";
        } else {
            this.element_root.className = "roster_entry_guest_li";
        }
        this.uri = participant_data["uri"];

        if (participant_data["display_name"] != "") {
            //this.uri = this.uri + " - " + participant_data["display_name"];
            this.uri = participant_data["display_name"];
        }

        if (this.uuid == user.participant_uuid) {
            this.uri = this.uri + " <span class='red'>[оператор]</span>";
        }

        this.uri_element = document.createElement("div");
        this.uri_element.className = "participant_uri";
        this.uri_element.innerHTML = this.uri;

        console.log("has_media " + participant_data["has_media"]);
        this.enable_media_buttons = participant_data["has_media"] && (user.role == 'HOST');

        // Add layout check
        this.layout = document.createElement("input");
        this.layout.setAttribute('type', 'checkbox');
        this.element_root.appendChild(this.layout);

        // Add avatar
        this.avatar = document.createElement("img");
        this.avatar.src = "https://" + user.node + "/api/client/v2/conferences/" + user.conference + "/participants/" + this.uuid + "/avatar.jpg?width=40&height=40&token=" + user.token;
        this.avatar.onerror = this.avatar_error.bind(this);
        this.element_root.appendChild(this.avatar);

        // Add protocol
        if (participant_data["protocol"] != undefined) {
            this.protocol_element = document.createElement("div");
            this.protocol_element.className = "participant_uri";
            this.protocol_element.innerHTML = "<b>" + participant_data["protocol"] + "</b>";
            this.element_root.appendChild(this.protocol_element);
        }

        // Add role host/guest
        this.chair_role_element = document.createElement("div");
        if (participant_data["role"] === "chair") {
            this.chair_role_element.className = class_role_chair;
        } else {
            this.chair_role_element.className = class_role_guest;
        }
        this.chair_role_element.addEventListener('click', this.chair_role.bind(this), false);
        this.element_root.appendChild(this.chair_role_element);

        // Add spotlight button/status
        this.spotlight_element = document.createElement("div");
        this.spotlight_state = participant_data["spotlight"] != 0;
        if (this.spotlight_state) {
            this.spotlight_element.className = class_spotlight_on;
        } else {
            this.spotlight_element.className = class_spotlight_off;
        }
        this.spotlight_element.addEventListener('click', this.spotlight.bind(this), false);
        this.element_root.appendChild(this.spotlight_element);

        // Add mute button/status
        this.mute_element = document.createElement("div");
        this.mute_state = participant_data["is_muted"] == "YES";
        if (this.mute_state) {
            this.mute_element.className = class_mute_on;
        } else {
            this.mute_element.className = class_mute_off;
        }
        this.mute_element.addEventListener('click', this.mute.bind(this), false);
        this.element_root.appendChild(this.mute_element);

        // Add hold/resume button/status
        this.hold_element = document.createElement("div");
        if (participant_data["is_held"] == "YES") {
            this.hold_element.className = class_hold_on;
        } else {
            this.hold_element.className = class_hold_off;
        }
        this.hold_element.addEventListener('click', this.hold.bind(this), false);
        this.element_root.appendChild(this.hold_element);

        // Add see presentation button/status
        this.see_presentation_element = document.createElement("div");
        this.see_presentation_state = participant_data["rx_presentation_policy"] == "ALLOW";
        console.log("see_presentation_state " + this.see_presentation_state);
        if (this.see_presentation_state) {
            this.see_presentation_element.className = class_see_presentation_allowed;
        } else {
            this.see_presentation_element.className = class_see_presentation_denied;
        }
        this.see_presentation_element.addEventListener('click', this.see_presentation.bind(this), false);
        this.element_root.appendChild(this.see_presentation_element);

        // Add overlay text
        this.overlay_text_element = document.createElement("div");
        this.overlay_text_element.className = "particpantOverlayText";

        var currentOverlayText = document.createElement("input");
        currentOverlayText.setAttribute('size', '30');
        currentOverlayText.className = "currentOverlayText";
        currentOverlayText.setAttribute('disabled', 'true');
        currentOverlayText.id = "currenttext_" + participant_data["uuid"];
        currentOverlayText.value = participant_data["overlay_text"];

        var newOverlayText = document.createElement("input");
        newOverlayText.setAttribute('size', '30');
        newOverlayText.className = "form-control newOverlayText";
        newOverlayText.id = "newtext_" + participant_data["uuid"];

        updateTextButton = document.createElement("div");
        updateTextButton.className = "buttonOverlayText fa fa-check white";
        updateTextButton.addEventListener('click', this.overlay.bind(this), false);

        this.overlay_text_element.appendChild(currentOverlayText);
        this.overlay_text_element.appendChild(newOverlayText);
        this.overlay_text_element.appendChild(updateTextButton);

        // Add transfer button
        if (participant_data["protocol"] != "mssip") {

            var transferText = document.createElement("input");
            transferText.className = "form-control newTransferText";
            transferText.id = "transfer_" + participant_data["uuid"];

            var transferButton = document.createElement("div");
            transferButton.className = "buttonOverlayText fa fa-mail-forward white";
            transferButton.addEventListener('click', this.transfer.bind(this), false);

            this.overlay_text_element.appendChild(transferText);
            this.overlay_text_element.appendChild(transferButton);
        }


        // Add disconnect button
        var disconnect = document.createElement("div");
        disconnect.className = class_disconnect;
        disconnect.addEventListener('click', this.disconnect.bind(this), false);
        this.element_root.appendChild(disconnect);

        // Add unlock
        this.unlock_element = document.createElement("div");
        this.unlock_element.className = "hide";
        this.unlock_element.addEventListener('click', this.unlock.bind(this), false);
        this.element_root.appendChild(this.unlock_element);

        this.element_root.appendChild(this.uri_element);
        this.element_root.appendChild(this.overlay_text_element);
        if (this.transfer_element != undefined) {
            this.element_root.appendChild(this.transfer_element);
        }

        if (!this.enable_media_buttons) {
            this.chair_role_element.classList.add("disabled_action");
            this.spotlight_element.classList.add("disabled_action");
            this.mute_element.classList.add("disabled_action");
            this.hold_element.classList.add("disabled_action");
            this.unlock_element.classList.add("disabled_action");
            this.see_presentation_element.classList.add("disabled_action");
            this.layout.classList.add("invisible");
        }

        // Add into the correct list based on service_type
        this.service_type = participant_data["service_type"];
        if (this.service_type == "conference" || this.service_type == "lecture" || this.service_type == "gateway") {
            console.log("Adding to rosterlist");
            document.getElementById("roster_list").appendChild(this.element_root);
        } else {
            console.log("Adding to waitingroom");
            if (user.locked == true) {
                // Show participant unlock button
                this.unlock_element.className = user.role + " " + class_lock_on;
            }
            document.getElementById("waitingroom_list").appendChild(this.element_root);
        }
    }

    Participant.prototype.update = function (participant_data) {
        // console.log("participant update " + this);
        pp = DumpObject(participant_data);
        console.log("participant update: " + JSON.stringify(pp));
        if (participant_data["service_type"] != this.service_type) {
            // Might need to move lists
            if (participant_data["service_type"] == "conference" || participant_data["service_type"] == "lecture" || participant_data["service_type"] == "gateway") {
                try {
                    document.getElementById("waitingroom_list").removeChild(this.element_root);
                } catch (error) {
                    console.log("Unable to remove participant from waiting room was:" + this.service_type + " now:" + participant_data["service_type"]);
                }
                document.getElementById("roster_list").appendChild(this.element_root);
            }
            this.service_type = participant_data["service_type"];
        }

        if (participant_data["protocol"] != undefined) {
            this.protocol_element.innerHTML = "<b>" + participant_data["protocol"] + "</b>";
        }

        if (participant_data["role"] == "chair") {
            this.element_root.className = "roster_entry_host_li";
        } else {
            this.element_root.className = "roster_entry_guest_li";
        }

        if (participant_data["has_media"] && user.role == 'HOST' && this.uuid !== user.participant_uuid) {
            this.enable_media_buttons = true;
        console.log("enable_media_buttons " + this.enable_media_buttons);
        }

        this.overlay_text = participant_data["overlay_text"];
        document.getElementById("currenttext_" + this.uuid).value = this.overlay_text;

        // Update mute status
        this.mute_state = participant_data["is_muted"] == "YES";
        if (this.mute_state) {
            this.mute_element.className = class_mute_on;
        } else {
            this.mute_element.className = class_mute_off;
        }

        // Update role
        if (participant_data["role"] === "chair") {
            this.chair_role_element.className = class_role_chair;
        } else {
            this.chair_role_element.className = class_role_guest;
        }

        // Update spotlight status
        this.spotlight_state = participant_data["spotlight"] != 0;
        if (this.spotlight_state) {
            this.spotlight_element.className = class_spotlight_on;
        } else {
            this.spotlight_element.className = class_spotlight_off;
        }

        // Update see presentation status
        this.see_presentation_state = participant_data["rx_presentation_policy"] == "ALLOW";
        if (this.see_presentation_state) {
            this.see_presentation_element.className = class_see_presentation_allowed;
        } else {
            this.see_presentation_element.className = class_see_presentation_denied;
        }

        if (!this.enable_media_buttons) {
            this.chair_role_element.classList.add("disabled_action");
            this.spotlight_element.classList.add("disabled_action");
            this.mute_element.classList.add("disabled_action");
            this.hold_element.classList.add("disabled_action");
            this.unlock_element.classList.add("disabled_action");
            this.see_presentation_element.classList.add("disabled_action");
            this.layout.classList.add("invisible");
        } else {
            this.chair_role_element.classList.remove("disabled_action");
            this.spotlight_element.classList.remove("disabled_action");
            this.mute_element.classList.remove("disabled_action");
            this.hold_element.classList.remove("disabled_action");
            this.layout.classList.remove("hide");
        }
    };

    Participant.prototype.remove = function () {
        console.log("participant remove " + this);
        if (this.service_type == "conference" || this.service_type == "lecture" || this.service_type == "gateway") {
            console.log("Remove from roster");
            try {
                document.getElementById("roster_list").removeChild(this.element_root);
            } catch (error) {
                console.log("Unable to remove from rosterlist");
            }
        } else {
            console.log("Remove from waitingroom");
            try {
                document.getElementById("waitingroom_list").removeChild(this.element_root);
            } catch (error) {
                console.log("Unable to remove from waitingroom");
            }
        }
    };

    Participant.prototype.disconnect = function () {
        console.log("participant disconnect " + this);
        if (user.role == "HOST") {
            user.post_request("participants/" + this.uuid + "/disconnect", null);
        }
    };

    Participant.prototype.mute = function () {
        console.log("participant mute " + this);
        if (this.enable_media_buttons) {
            if (this.mute_state) {
                user.post_request("participants/" + this.uuid + "/unmute", null);
                this.mute_state = false;
                this.mute_element.className = class_mute_off;
            } else {
                user.post_request("participants/" + this.uuid + "/mute", null);
                this.mute_state = true;
                this.mute_element.className = class_mute_on;
            }
        }
    };

    Participant.prototype.spotlight = function () {
        console.log("participant spotlight " + this);
        if (this.enable_media_buttons) {
            if (this.spotlight_state) {
                user.post_request("participants/" + this.uuid + "/spotlightoff", null);
                this.spotlight_element.className = class_spotlight_off;
            } else {
                user.post_request("participants/" + this.uuid + "/spotlighton", null);
                this.spotlight_element.className = class_spotlight_on;
            }
        }
    };

    Participant.prototype.chair_role = function () {
        console.log("participant chair role " + this);
        if (user.role == "HOST") {
            if (this.chair_role_element.className === class_role_chair)
            {
                user.post_request("participants/" + this.uuid + "/role", { "role": "guest" });
                this.chair_role_element.className = class_role_guest;
            } else
            {
                user.post_request("participants/" + this.uuid + "/role", { "role": "chair" });
                this.chair_role_element.className = class_role_chair;
            }
        }
    };

    Participant.prototype.hold = function () {
        console.log("participant hold " + this);
        if (this.enable_media_buttons) {
            if (this.hold_element.className == user.role + " " + class_hold_on) {
                user.post_request("participants/" + this.uuid + "/resume", null);
                this.hold_element.className = user.role + " " + class_hold_off;
            } else {
                user.post_request("participants/" + this.uuid + "/hold", null);
                this.hold_element.className = user.role + " " + class_hold_on;
            }
        }
    };

    Participant.prototype.start_speaking = function () {
        console.log("participant start_speaking " + this);
        if (!this.speaking) {
            this.speaking = true;
            this.uri_element.className = "participant_uri_speaking";
        }
    };

    Participant.prototype.stop_speaking = function () {
        console.log("participant stop_speaking " + this);
        if (this.speaking) {
            this.speaking = false;
            this.uri_element.className = "participant_uri";
        }
    };

    Participant.prototype.unlock = function () {
        console.log("participant unlock " + this);
        if (this.enable_media_buttons) {
            user.post_request("participants/" + this.uuid + "/unlock", null);
            this.unlock_element.className = "hide";
        }
    };

    Participant.prototype.conference_lock = function (locked) {
        console.log("participant conference_lock " + this);
        if (this.service_type != "conference" && this.service_type != "lecture") {
            if (locked == true) {
                // Show participant unlock button
                this.unlock_element.className = class_lock_on;
            } else {
                this.unlock_element.className = "hide";
            }
        }
    };

    Participant.prototype.overlay = function () {
        console.log("participant overlay " + this);
        if (this.enable_media_buttons) {
            var overlay = document.getElementById("newtext_" + this.uuid).value;
            var text_data = { "text": overlay };
            var response = user.post_request("participants/" + this.uuid + "/overlaytext", text_data);
            if (response["status"] == 200) {
                document.getElementById("currenttext_" + this.uuid).value = overlay;
                document.getElementById("newtext_" + this.uuid).value = "";
            } else {
                document.getElementById("newtext_" + this.uuid).value = "FAILED";
            }
        }
    };

    Participant.prototype.transfer = function () {
        console.log("participant transfer" + this);
        var target = document.getElementById("transfer_" + this.uuid).value;
        var text_data = { "conference_alias": target };
        var response = user.post_request("participants/" + this.uuid + "/transfer", text_data);
    };

    Participant.prototype.see_presentation = function () {
        console.log("participant see presentation " + this);
        if (user.role == 'HOST') {
            if (this.see_presentation_state) {
                user.post_request("participants/" + this.uuid + "/denyrxpresentation", null);
                this.see_presentation_state = false;
                this.see_presentation_element.className = class_see_presentation_denied;
            } else {
                user.post_request("participants/" + this.uuid + "/allowrxpresentation", null);
                this.see_presentation_state = true;
                this.see_presentation_element.className = class_see_presentation_allowed;
            }
        }
    };

    Participant.prototype.avatar_error = function () {
        var fallback = "data:image/png;base64,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";
        this.avatar.src = fallback;
        this.avatar.height = 40;
    };

    Participant.prototype.selected_for_layout = function () {
        return this.layout.checked;
    };

    var user = {
        node: "@MvcApplication.set.CobaCfgAddress",
        conference: "@ViewData["confnm"]",
        display_name: "@ViewData["dispnm"]",
        role: "HOST",
        token: null,
        participant_uuid: null,
        pin: "@ViewData["pinc"]",
        event_source: null,
        conference_participants: {},
        token_refresh: null,
        locked: false,
        live_active: false,
        guests_muted: false,
        live_active_call: null,
        last_message_origin: null,
        record_server: "@MvcApplication.set.CobaRecordsAddress",
        recorded: false,
        record_pid: null,
        record_id: null,

        join: function () {
            this.join_with_token(null);
            return false;
        },

        join_with_token: function (token) {
            // Parse conference input into node and conference name
            if (token) {
                this.token = token;
            }
            if (this.request_token()) {
                if (this.start_events()) {
                    var conference_status = this.get_request("conference_status");
                    if (conference_status["status"] === 200) {
                        if (conference_status["data"]["result"]["locked"]) {
                            this.locked = true;
                            document.getElementById("conflock").className = class_conference_lock_on;
                        } else {
                            this.locked = false;
                            document.getElementById("conflock").className = class_conference_lock_off;
                        }
                        if (conference_status["data"]["result"]["guests_muted"]) {
                            this.guests_muted = true;
                            document.getElementById("guestsmuted").className = class_conference_guests_mute_on;
                        } else {
                            this.guests_muted = false;
                            document.getElementById("guestsmuted").className = class_conference_guests_mute_off;
                        }
                    }
                    document.getElementById("disconnectall").className = class_conference_disconnect_all;
                    document.getElementById("record").className = class_conference_record_off;

                    if (this.role == 'GUEST') {
                        document.getElementById("host").classList.add("disabled_action");
                        document.getElementById("conflock").classList.add("disabled_action");
                        document.getElementById("guestsmuted").classList.add("disabled_action");
                        document.getElementById("disconnectall").classList.add("disabled_action");
                        document.getElementById("record").classList.add("disabled_action");
                    }

                    document.getElementById("confcontrol").className = "control_panel";
                    if (typeof jwplayer !== 'undefined') {
                        document.getElementById("liveviewdiv").className = "liveviewdiv";
                    }
                    console.log("Joined " + this);
                } else {
                    this.release_token();
                }
            }
        },

        leave: function () {
            if (this.live_active) {
                try {
                    jwplayer("liveviewplayer").remove();
                    jwplayer("liveviewpresplayer").remove();
                }
                catch (err) {
                    console.log("Failed to remove jwplayer");
                }
                this.live_active = false;
            }

            if (this.event_source) {
                this.event_source.close();
                this.event_source = null;
            }
            console.log("leave " + this);

            if (this.token_refresh) {
                clearInterval(this.token_refresh);
                this.token_refresh = null;
            }

            for (var participant in this.conference_participants) {
                if (this.conference_participants.hasOwnProperty(participant)) {
                    this.conference_participants[participant].remove();
                }
            }

            this.conference_participants = {};

            this.release_token();
            if (this.recorded === true) {
                this.record();
            }

            document.getElementById("presentation").className = "hide";

            var player_wrapper = document.getElementById("liveviewplayer_wrapper");
            if (player_wrapper != null) {
                player_wrapper.innerHTML = "";
                player_wrapper.removeAttribute("style");
                console.log("Reset innerHTML and style");
                player_wrapper.id = "liveviewplayer";
            }
            document.getElementById("liveviewdiv").className = "hide";
            document.getElementById("rtmpaddress").value = "";
            document.getElementById("confcontrol").className = "hide";

            return false;
        },

        request_token: function () {
            var data = { "display_name": this.display_name };
            var response = this.post_request("request_token", data);
            console.log("response " + response["status"]);
            if (response["status"] === 200) {
                this.token = response["data"]["result"]["token"];
                this.participant_uuid = response["data"]["result"]["participant_uuid"];
                this.role = response["data"]["result"]["role"];
                if (this.role == undefined) {
                    this.role = "HOST";
                }
                var expires = response["data"]["result"]["expires"];
                if (expires === undefined) {
                    expires = 120;
                }
                this.token_refresh = setInterval(this.refresh_token.bind(this), (expires * 1000) / 2);
                var chat_enabled = response["data"]["result"]["chat_enabled"];
                if (chat_enabled == true) {
                    document.getElementById("chatdiv").className = "chatdiv";
                } else {
                    document.getElementById("chatdiv").className = "hide";
                }
                return true;
            } else if (response["status"] == 403) {
                console.log("Pin required");
                join_error.innerHTML = "Failed to join conference: Pin required";
            } else if (response["status"] == 0) {
                join_error.innerHTML = "Failed to join conference: " + JSON.stringify(response["data"]);
            } else {
                join_error.innerHTML = "Failed to join conference: " + response["status"] + "(" + JSON.stringify(response["data"]) + ")";
            }
            return false;
        },

        refresh_token: function () {
            console.log("refresh_token this " + this);
            var response = this.post_request("refresh_token", null);
            console.log("response " + response["status"]);
            if (response["status"] == 200) {
                this.token = response["data"]["result"]["token"];
            } else {
                console.log("Refresh failed, leave conference");
                this.leave();
                alert("Token refresh failed");
            }
            return false;
        },

        release_token: function () {
            if (this.token) {
                this.post_request("release_token", null);
                this.token = null;
            }
        },

        liveview: function () {
            if (this.token) {
                console.log("live_active " + this.live_active);
                if (this.live_active == false) {
                    var call_data = { "call_type": "rtmp", "streaming": "true" };
                    var response = user.post_request("participants/" + this.participant_uuid + "/calls", call_data);
                    if (response["status"] == 200) {
                        var url = response["data"]["result"]["url"] + "-stream";
                        this.live_active_call = response["data"]["result"]["call_uuid"];
                        console.log("url: " + url);
                        this.live_active = true;
                        document.getElementById("liveview").value = "Отключить просмотр";
                        jwplayer("liveviewplayer").setup({
                            file: url,
                            height: 198,
                            width: 352,
                            aspectratio: "16:9",
                            controls: false,
                            stretching: "exactfit",
                        });
                        jwplayer("liveviewplayer").play(true);
                        setTimeout(user.player_wrapper, 300);
                    }
                } else {
                    this.live_active = false;
                    document.getElementById("liveview").value = "Просмотр видео";
                    var player_wrapper = document.getElementById("liveviewplayer_wrapper");
                    if (player_wrapper != null) {
                        player_wrapper.innerHTML = "";
                        player_wrapper.removeAttribute("style");
                        player_wrapper.id = "liveviewplayer";
                        player_wrapper.setAttribute("class", "liveviewdiv_player");
                    }
                    var response = user.post_request("participants/" + this.participant_uuid + "/calls/" + this.live_active_call + "/disconnect", null);
                    this.live_active_call = null;
                }
            }
        },

        player_wrapper: function (){
            var player_wrapper = document.getElementById("liveviewplayer_wrapper");
            if (player_wrapper != null) {
                player_wrapper.removeAttribute("style");
                player_wrapper.setAttribute("class", "liveviewdiv_player");
            }
        },

        getrtmpaddress: function () {
            if (this.token) {
                document.getElementById("rtmpaddress").value = "";
                var call_data = { "call_type": "rtmp", "streaming": "true" };
                var response = user.post_request("participants/" + this.participant_uuid + "/calls", call_data);
                if (response["status"] == 200) {
                    var url = response["data"]["result"]["url"] + "-stream";
                    console.log("url: " + url);
                    document.getElementById("rtmpaddress").value = url;
                }
            }
        },

        record: function () {
            if (this.recorded == false) {
                if (this.token) {
                    var call_data = { "call_type": "rtmp", "streaming": "true" };
                    var response = user.post_request("participants/" + this.participant_uuid + "/calls", call_data);
                    if (response["status"] == 200) {
                        var url = response["data"]["result"]["url"] + "-stream";
                        console.log("url: " + url);
                    }
                }
                var params = { "vmr": this.conference, "name": this.display_name, "link": url, };
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "https://" + this.record_server + "/recordstart.php", false);
                xhr.onerror = function () { this.onError(this.trans.ERROR_CONNECTING); };
                xhr.ontimeout = function () { this.onError(this.trans.ERROR_CONNECTING); };
                console.log(params);
                xhr.setRequestHeader('Content-type', 'application/json;charset=UTF-8"');
                xhr.send(JSON.stringify(params));
                console.log("Response: " + xhr.responseText);
                var msg = {};
                try {
                    msg = JSON.parse(xhr.responseText);
                } catch (error) {
                    msg.reason = xhr.status + " " + xhr.statusText;
                }
                msg.http_status = xhr.status;
                if (msg["http_status"] == 200) {
                    this.record_pid = msg.pid;
                    this.record_id = msg.ID_rec;
                    this.recorded = true;
                    document.getElementById("record").className = class_conference_record_on;
                }
            } else {
                var params = { "pid": this.record_pid, "ID_rec": this.record_id, };
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "https://" + this.record_server + "/recordstop.php", false);
                xhr.onerror = function () { this.onError(this.trans.ERROR_CONNECTING); };
                xhr.ontimeout = function () { this.onError(this.trans.ERROR_CONNECTING); };
                console.log(params);
                xhr.setRequestHeader('Content-type', 'application/json');
                xhr.send(JSON.stringify(params));
                console.log("Response: " + xhr.responseText);
                var msg = {};
                try {
                    msg = JSON.parse(xhr.responseText);
                } catch (error) {
                    msg.reason = xhr.status + " " + xhr.statusText;
                }
                msg.http_status = xhr.status;
                if (msg.ok == "ok") {
                    this.recorded = false;
                    document.getElementById("record").className = class_conference_record_off;
                }
            }
        },

        lock: function () {
            if (this.role == "HOST") {
                if (this.locked == true) {
                    this.post_request("unlock", null);
                    this.locked = false;
                    document.getElementById("conflock").className = class_conference_lock_off;
                } else {
                    this.post_request("lock", null);
                    this.locked = true;
                    document.getElementById("conflock").className = class_conference_lock_on;
                }
            }
        },

        muteallguests: function () {
            if (this.role == "HOST") {
                if (this.guests_muted == true) {
                    this.post_request("unmuteguests", null);
                    this.guests_muted = false;
                    document.getElementById("guestsmuted").className = class_conference_guests_mute_off;
                } else {
                    this.post_request("muteguests", null);
                    this.guests_muted = true;
                    document.getElementById("guestsmuted").className = class_conference_guests_mute_on;
                }
            }
        },

        send_message: function () {
            var chatinput_element = document.getElementById("chatinput");
            var call_data = {
                "type": "text/plain",
                "payload": chatinput_element.value
            };
            this.post_request("message", call_data);
            this.display_message("Me", chatinput_element.value);
            chatinput_element.value = "";
            return false;
        },

        receive_message: function (event) {
            message_data = JSON.parse(event.data);
            console.log("message " + message_data["origin"] + " " + message_data["payload"]);
            this.display_message(message_data["origin"], message_data["payload"]);
        },

        display_message: function (origin, message) {
            var chatbox_element = document.getElementById("chatbox");
            if (this.last_message_origin != origin) {
                this.last_message_origin = origin;
                var origin_element = document.createElement("span");
                origin_element.className = "message_origin";
                origin_element.innerHTML = origin + "<br/>";
                chatbox_element.appendChild(origin_element);
            }
            var message_element = document.createElement("span");
            message_element.className = "message";
            message_element.innerHTML = message + "<br/>";
            chatbox_element.appendChild(message_element);
            chatbox_element.scrollTop = chatbox_element.scrollHeight;
        },

        disconnect_all: function () {
            if (this.role == "HOST") {
                this.post_request("disconnect", null);
            }
        },

        start_events: function () {
            this.event_source = new EventSource("https://" + this.node + "/api/client/v2/conferences/" + this.conference + "/events?token=" + this.token);
            this.event_source.addEventListener("disconnect", user.disconnect.bind(this), false);
            this.event_source.addEventListener("conference_update", user.conference_update.bind(this), false);
            this.event_source.addEventListener("participant_create", user.participant_create.bind(this), false);
            this.event_source.addEventListener("participant_delete", user.participant_delete.bind(this), false);
            this.event_source.addEventListener("participant_update", user.participant_update.bind(this), false);
            this.event_source.addEventListener("presentation_start", user.presentation_start.bind(this), false);
            this.event_source.addEventListener("presentation_stop", user.presentation_stop.bind(this), false);
            this.event_source.addEventListener("presentation_frame", user.presentation_frame.bind(this), false);
            this.event_source.addEventListener("stage", user.stage.bind(this), false);
            this.event_source.addEventListener("refer", user.refer.bind(this), false);
            this.event_source.addEventListener("message_received", user.receive_message.bind(this), false);
            return true;
        },

        disconnect: function (event) {
            disconnect_data = JSON.parse(event.data);
            console.log("disconnect");
            this.leave();
            alert("You have been disconnected: " + disconnect_data["reason"]);
        },

        refer: function (event) {
            refer_data = JSON.parse(event.data);
            console.log("refer");
            this.leave();
            document.getElementById("conference").value = refer_data["alias"];
            this.join();
        },

        conference_update: function (event) {
            conference_data = JSON.parse(event.data);
            console.log("conference_update");
            if (conference_data["locked"]) {
                this.locked = true;
                document.getElementById("conflock").className = class_conference_lock_on;
            } else {
                this.locked = false;
                document.getElementById("conflock").className = class_conference_lock_off;
            }
            if (conference_data["guests_muted"]) {
                this.guests_muted = true;
                document.getElementById("guestsmuted").className = class_conference_guests_mute_on;
            } else {
                this.guests_muted = false;
                document.getElementById("guestsmuted").className = class_conference_guests_mute_off;
            }
            if (this.role == 'GUEST') {
                document.getElementById("host").classList.add("disabled_action");
                document.getElementById("conflock").classList.add("disabled_action");
                document.getElementById("guestsmuted").classList.add("disabled_action");
                document.getElementById("disconnectall").classList.add("disabled_action");
                document.getElementById("record").classList.add("disabled_action");
            }
            // Go through all participants in the waitingroom and show/hide unlock icon
            for (var participant in this.conference_participants) {
                if (this.conference_participants.hasOwnProperty(participant)) {
                    this.conference_participants[participant].conference_lock(this.locked);
                }
            }
        },

        participant_create: function (event) {
            participant_data = JSON.parse(event.data);
            console.log("participant_create " + participant_data["service_type"]);
            var new_participant = new Participant(participant_data);
            this.conference_participants[participant_data["uuid"]] = new_participant;
        },

        participant_delete: function (event) {
            participant_data = JSON.parse(event.data);
            console.log("participant_delete");
            this.conference_participants[participant_data["uuid"]].remove();
            delete this.conference_participants[participant_data["uuid"]];
        },

        participant_update: function (event) {
            participant_data = JSON.parse(event.data);
            console.log("participant_update " + participant_data["service_type"]);
            this.conference_participants[participant_data["uuid"]].update(participant_data);
        },

        presentation_start: function (event) {
            console.log("presentation_start");
            document.getElementById("presentation").className = "liveviewdiv_player";
        },

        presentation_stop: function (event) {
            console.log("presentation_stop");
            document.getElementById("presentation").className = "liveviewdiv_player";
        },

        presentation_frame: function (event) {
            console.log("presentation_frame");
            var presentation = document.getElementById("presentation");
            presentation.src = "https://" + this.node + "/api/client/v2/conferences/" + this.conference + "/presentation.jpeg?id=" + event.lastEventId + "&token=" + this.token;
        },

        stage: function (event) {
            console.log("stage");
            stage_data = JSON.parse(event.data);
            var is_speaking = [];
            for (var i = 0; i < stage_data.length; i++) {
                if (stage_data[i]['vad'] > 0) {
                    is_speaking[is_speaking.length] = stage_data[i]['participant_uuid'];
                }
            }
            for (var participant in this.conference_participants) {
                if (this.conference_participants.hasOwnProperty(participant)) {
                    if (is_speaking.indexOf(participant) > -1) {
                        this.conference_participants[participant].start_speaking();
                    } else {
                        this.conference_participants[participant].stop_speaking();
                    }
                }
            }

        },

        overridelayout: function (event) {
            var layouts = [];
            var participant_ids = [];
            for (var participant in this.conference_participants) {
                if (this.conference_participants.hasOwnProperty(participant)) {
                    if (this.conference_participants[participant].selected_for_layout()) {
                        participant_ids[participant_ids.length] = this.conference_participants[participant].uuid;
                    }
                }
            }
            console.log("participants: " + participant_ids);
            var actors_element = document.getElementById("actors");
            var layout_element = document.getElementById("layout");
            var plusn_element = document.getElementById("plusn");
            var vadbackfill_element = document.getElementById("vadbackfill");
            var overlaytext_element = document.getElementById("overlay_text");
            var audience_element = document.getElementById("audience");
            var actors_value = participant_ids;
            if (actors_element.value == "everyone") {
                actors_value = [];
            }

            var audience_value = [];
            if (audience_element.value == "hosts") {
                audience_value = "hosts";
            }

            layouts.push({
                "actors": actors_value,
                "layout": layout_element.value,
                "plus_n": plusn_element.value,
                "vad_backfill": vadbackfill_element.checked,
                "actors_overlay_text": overlaytext_element.value,
                "audience": audience_value
            });

            if (audience_value == "hosts") {
                // Get the "guests" view
                var guest_actors_element = document.getElementById("guest_actors");
                var guest_layout_element = document.getElementById("guest_layout");
                var guest_plusn_element = document.getElementById("guest_plusn");
                var guest_vadbackfill_element = document.getElementById("guest_vadbackfill");
                var guest_overlaytext_element = document.getElementById("guest_overlay_text");
                var guest_audience_element = document.getElementById("guest_audience");
                var guest_actors_value = participant_ids;
                if (guest_actors_element.value == "everyone") {
                    guest_actors_value = [];
                }
                layouts.push({
                    "actors": guest_actors_value,
                    "layout": guest_layout_element.value,
                    "plus_n": guest_plusn_element.value,
                    "vad_backfill": guest_vadbackfill_element.checked,
                    "actors_overlay_text": guest_overlaytext_element.value,
                    "audience": []
                });
            }

            var call_data = { "layouts": layouts };
            var response = user.post_request("override_layout", call_data);
            if (response["status"] == 200) {
                console.log("Set new layout!");
            }
        },

        dial: function (event) {
            var protocol = document.getElementById("protocol");
            var localalias = document.getElementById("localalias");
            var remotealias = document.getElementById("remotealias");
            var role = document.getElementById("role");

            var call_data = {
                "protocol": protocol.value,
                "source": localalias.value,
                "destination": remotealias.value,
                "role": role.value
            };
            if (protocol.value == "rtmp") {
                call_data["streaming"] = "yes";
            }
            var response = user.post_request("dial", call_data);
            if (response["status"] == 200) {
                console.log("Dial out success");
            }
        },

        dial_pb: function (addr, protocol, name) {
            var localalias = document.getElementById("localalias");
            var role = "guest";

            var call_data = {
                "protocol": protocol,
                "source": name,
                "destination": addr,
                "role": "guest"
            };
            var response = user.post_request("dial", call_data);
            if (response["status"] == 200) {
                console.log("Dial out success");
            }
        },

        resetlayout: function (event) {
            var call_data = { "layouts": [] };
            var response = user.post_request("override_layout", call_data);
            if (response["status"] == 200) {
                console.log("Reset layout!");
            }
        },

        post_request: function (command, data) {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("POST", "https://" + this.node + "/api/client/v2/conferences/" + this.conference + "/" + command, false);
            if (this.token) {
                xmlhttp.setRequestHeader("token", this.token);
            }
            if (this.pin) {
                xmlhttp.setRequestHeader("pin", this.pin);
            }
            try {
                if (data) {
                    xmlhttp.setRequestHeader("Content-Type", "application/json");
                    xmlhttp.send(JSON.stringify(data));
                } else {
                    xmlhttp.send();
                }
                console.log("responseText " + xmlhttp.responseText);
                return { "status": xmlhttp.status, "data": JSON.parse(xmlhttp.responseText) };
            } catch (exception) {
                console.log("Exception during post_request");
                return { "status": xmlhttp.status, "data": { "reason": exception.toString() } };
            }
        },

        get_request: function (command) {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET", "https://" + this.node + "/api/client/v2/conferences/" + this.conference + "/" + command, false);
            if (this.token) {
                xmlhttp.setRequestHeader("token", this.token);
            }
            if (this.pin) {
                xmlhttp.setRequestHeader("pin", this.pin);
            }
            try {
                xmlhttp.send();
                console.log("responseText " + xmlhttp.responseText);
                return { "status": xmlhttp.status, "data": JSON.parse(xmlhttp.responseText) };
            } catch (exception) {
                console.log("Exception during get_request");
                return { "status": xmlhttp.status, "data": { "reason": exception.toString() } };
            }
        },
    };
</script>